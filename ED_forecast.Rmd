---
title: "forecasting ED"
author: "Janice Hsu"
date: "2023-08-28"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(fpp3)
library(hts)
```


```{r}
data <- read.csv("HLTH0037_ts_cleaned.csv")
```

```{r}
data %>%
  select(Hospital_Hierarchy, Organisation) %>%
unique() 
```

```{r}
data1 <- data %>%
  mutate(YearMonth = yearmonth(YearMonth)) %>%
  as_tsibble(index = YearMonth, key = c(Age_Code, Sex_ItemName_ENG, Hospital_Code, Hospital_ItemName_ENG)) 

data1 <- data1 %>%
  mutate(Number = 1)
```


```{r}
#Produce a table or plot to show the hierarchy between the organisation and hospital hierarchy

data2 <- data1 %>%
  select(YearMonth, Hospital_ItemName_ENG, Hospital_Hierarchy, Organisation, Number)
```


```{r}
# Convert to data.table
library(data.table)
setDT(data2)

# Create a hierarchical table using data.table operations
hierarchical_table <- data2[, .(Total = sum(Number)), by = .( Organisation, Hospital_ItemName_ENG)]

knitr::kable(hierarchical_table)

```


```{r}
#Number of patients entering ED under different hospital hierarchy

data1_hts <- data1 %>%
  aggregate_key(Organisation/Hospital_ItemName_ENG, Number = sum(Number))
  
data1_hts |>
  filter(is_aggregated(Hospital_ItemName_ENG)) |>
  autoplot(Number) +
  labs(y = "Number of patients",
       title = "Number of patients who enter ED") +
  facet_wrap(vars(Organisation), scales = "free_y", ncol = 3) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```


•	A couple of Local Health Boards (LHBs) were redefined from the 1st of April 2019 onwards: Cwm Taf (27)--> Cwm Taf Morgannwg (30)// Abertawe Bro Morgannwg (26) --> Swansea Bay (31). Therefore, if you decide to forecast at LHB resolution, you might want to consider these 4 as a unique one. 
•	A the Princess of Wales Hospital changed its Local Health Boards
•	So we analyse these 4 as one organisation


```{r}

data1_grouped <- data1 %>%
  mutate(Grouped_Organisation = case_when(
    Organisation %in% c("Cwm Taf", "Cwm Taf Morgannwg", "Abertawe Bro Morgannwg", "Swansea Bay") ~ "Grouped_organisation",
    TRUE ~ Organisation
  ))

```


```{r}
unique(data1_grouped$Grouped_Organisation)
```


```{r}
data2_hts <- data1_grouped %>%
  group_by(Grouped_Organisation) %>%
  summarise(Number = sum(Number))
```


```{r}
data2_hts |>
  ggplot(aes(x = YearMonth, y = Number)) +
  geom_line(stat = "identity") +
  labs(y = "Number of patients",
       title = "Number of patients who enter ED") +
  facet_wrap(vars(Grouped_Organisation), scales = "free_y", ncol = 3) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
#library(gt)

#data2_hts %>%
  #gt() %>%
  #tab_header(title = "Number of patients who enter ED") %>%
  #cols_label(
    #YearMonth = "Year/Month",
    #Number = "Number of Patients",
    #Grouped_Organisation = "Organisation Group"
  #)

```

```{r}
unique(data1_grouped$Age_Code)
```


Age group: "0-4", "5-17", "18-69", "70^"
```{r}
data1_grouped_age <- data1_grouped %>%
  filter(Age_Code != "Unknown") %>%
  mutate(Grouped_Age = case_when(
    Age_Code == "0 to 4" ~ "0-4",
    Age_Code == "5 to 17" ~ "5-17",
    Age_Code %in% c("18 to 24", "25 to 29", "30 to 34", "35 to 39", 
                    "40 to 44", "45 to 49", "50 to 54", "55 to 59", 
                    "60 to 64", "65 to 69") ~ "18-69",
    Age_Code %in% c("70 to 74", "75 to 79", "80 to 84", "85") ~ "70 and over",
    TRUE ~ "Other"
  ))

```


```{r}

data1_gts <- data1_grouped_age %>%
  filter(!Sex_ItemName_ENG == "Not Specified  or invalid") %>%
  aggregate_key(Grouped_Age* Sex_ItemName_ENG , Number = sum(Number))

data1_gts |>
  filter(!is_aggregated(Sex_ItemName_ENG), !is_aggregated(Grouped_Age)) |>
  autoplot(Number) +
  labs(y = "Number of patients")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```





```{r}
# Number of patients entering ED, facet by sex

data3_ghts <- data1_grouped_age %>%
  aggregate_key((Grouped_Organisation/Hospital_Hierarchy)* Sex_ItemName_ENG , Number = sum(Number))

data3_ghts |>
  filter(!is_aggregated(Hospital_Hierarchy)) |>
  autoplot(Number) +
  labs(y = "Number of patients",
       title = "Number of patients who enter ED") +
  facet_wrap(vars(Sex_ItemName_ENG), scales = "free_y", ncol = 3) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

----------------------------

```{r}
data1_full <- data1_grouped_age |>
  aggregate_key(Grouped_Organisation/Hospital_ItemName_ENG, Number = sum(Number))

data1_full$key_combined <- paste(data1_full$Grouped_Organisation, data1_full$Hospital_ItemName_ENG, sep = "_")

```


```{r}
library(lubridate)


data1_wide <- data1_full %>%
   pivot_wider(names_from = key_combined, values_from = Number)


```



```{r}
library(hts)

reconcile_data1_wide_paths <- function(data1_full) {
  
  # Convert to regular data frame to bypass tsibble constraints
  data1_full <- as.data.frame(data1_full)
  
  # Convert YearMonth to date
  data1_wide <- data1_full %>%
    unite("key_column", Grouped_Organisation, Hospital_ItemName_ENG, sep = "_") %>%
    pivot_wider(names_from = key_column, values_from = Number, values_fill = list(Number = 0))
  
  # Convert the data to a gts object
  ts_data <- ts(data1_wide[,-1], frequency = 12, start = c(year(min(ymd(paste0(data1_wide$YearMonth, "-01")))), month(min(ymd(paste0(data1_wide$YearMonth, "-01"))))))
  gts_obj <- hts(ts_data)
  
  return(gts_obj)
}

# Calling the function
gts_obj = reconcile_data1_wide_paths(data1_full)

```



```{r}
# First, forecast each individual series with ets
individual_forecasts <- lapply(1:ncol(gts_obj[[1]]), function(i) {
  ets_forecast <- forecast(ets(gts_obj[[1]][,i]), h = 6)
  return(ets_forecast$mean)
})

# Combine the forecasts into a matrix
forecast_matrix <- do.call(cbind, individual_forecasts)

# Now, reconcile the forecasts using hts
gts_forecast_matrix <- ts(forecast_matrix, frequency = 12)
gts_forecasts <- hts(gts_forecast_matrix)
reconciled_forecasts <- forecast(gts_forecasts, method = "bu")

# Print the reconciled forecasts
print(reconciled_forecasts)

```

Forecasting Each Series with ets:

```{r}
individual_forecasts <- lapply(1:ncol(gts_obj[[1]]), function(i) {
  ets_forecast <- forecast(ets(gts_obj[[1]][,i]), h = 6)
  return(ets_forecast$mean)
})

```

Combine the Forecasts into a Matrix

```{r}
forecast_matrix <- do.call(cbind, individual_forecasts)

```

Convert to HTS Structure:

```{r}
gts_forecast_matrix <- ts(forecast_matrix, frequency = 12)
gts_forecasts <- hts(gts_forecast_matrix)

```

Reconcile the Forecasts:
```{r}
reconciled_forecasts <- forecast(gts_forecasts, method = "bu", h = 6)

```



```{r}
print(reconciled_forecasts)
```



